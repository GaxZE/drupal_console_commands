# Usage: drupal site:update --placeholder="name:subscriptions"
command:
  name: site:update
  description: 'Sets the site up based on current configuration and database.'
commands:
# We must ensure we run this command first in all chains to setup our console environment.
  - command: site:base:setup
    arguments:
      name: '%{{name}}'
# Set default drush alias.
  - command: exec
    arguments:
      bin: 'cd ${{site_destination_directory}}/web; drush site-set @site;'
# Put the site in maintenance mode.
  - command: exec
    arguments:
      bin: 'cd ${{site_destination_directory}}/web; drush sset system.maintenance_mode 1;'
# Clear cache
  - command: exec
    arguments:
      bin: 'cd ${{site_destination_directory}}/web; drush cr;'
# Run db updates.
  - command: exec
    arguments:
      bin: 'cd ${{site_destination_directory}}/web; drush updb -y;'
# Import configuration twice to fix a problem with config import when new modules are added to 'core.extensions.yml'.
  - command: exec
    arguments:
      bin: 'cd ${{site_destination_directory}}/web; drush cim -y; drush cim -y'
# Take the site out of maintenance mode.
  - command: exec
    arguments:
      bin: 'cd ${{site_destination_directory}}/web; drush sset system.maintenance_mode 0;'
# Clear cache.
  - command: exec
    arguments:
      bin: 'cd ${{site_destination_directory}}/web; drush cr;'
